<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CMS Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#f7f7fb; color:#111827; }
    header { background:#0b2a5b; color:#fff; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; }
    header a { color:#fff; text-decoration:none; margin-left:12px; }
    .wrap { max-width:1100px; margin: 18px auto; padding: 0 14px; }
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px; }
    .k { color:#6b7280; font-size:12px; }
    .v { font-size:22px; font-weight:700; margin-top:6px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; font-size:14px; }
    th { color:#374151; font-size:12px; text-transform: uppercase; letter-spacing: .06em; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .ok { background:#dcfce7; color:#166534; }
    .warn { background:#fef9c3; color:#854d0e; }
    .bad { background:#fee2e2; color:#991b1b; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px; }
    @media(max-width: 900px) { .grid { grid-template-columns: repeat(2,1fr);} .two{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <header>
    <div><b>CMS Admin Dashboard</b></div>
    <div>
      <a href="index.html">Main App</a>
      <a href="logs.html">Logs</a>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="k">Status</div>
        <div id="badge" class="v"><span class="badge ok">OK</span></div>
      </div>
      <div class="card">
        <div class="k">Total requests</div>
        <div id="total" class="v">—</div>
      </div>
      <div class="card">
        <div class="k">OK</div>
        <div id="ok" class="v">—</div>
      </div>
      <div class="card">
        <div class="k">Avg latency (ms)</div>
        <div id="avg" class="v">—</div>
      </div>
    </div>

    <div class="two">
      <div class="card">
        <h3 style="margin:0 0 10px 0;">By Campus</h3>
        <table>
          <thead>
            <tr><th>Campus</th><th>Total</th><th>OK</th><th>Bad</th></tr>
          </thead>
          <tbody id="campusRows"></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0;">By Handbook (selected context)</h3>
        <div class="k" style="margin-bottom:10px;">
          This appears when app sends handbook context (campus/program/id).
        </div>
        <table>
          <thead>
            <tr><th>Handbook</th><th>Total</th><th>OK</th><th>Bad</th></tr>
          </thead>
          <tbody id="hbRows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="admin.js"></script>
  <script>
    (async function init(){
      if (!requireAdminOrRedirect()) return;

      try {
        const data = await adminFetch("/admin/stats?limit=250");
        if (!data) return;

        // badge
        const badgeEl = document.getElementById("badge");
        const b = (data.badge || "OK").toUpperCase();
        const cls = b === "BAD" ? "bad" : (b === "WARN" ? "warn" : "ok");
        badgeEl.innerHTML = `<span class="badge ${cls}">${escapeHtml(b)}</span>`;

        document.getElementById("total").textContent = data.total ?? 0;
        document.getElementById("ok").textContent = data.ok ?? 0;
        document.getElementById("avg").textContent = data.avg_ms ?? 0;

        // campus table
        const campusRows = document.getElementById("campusRows");
        campusRows.innerHTML = "";
        const entries = Object.entries(data.byCampus || {}).sort((a,b)=> (b[1].total||0)-(a[1].total||0));
        for (const [campus, row] of entries) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(campus)}</td>
            <td>${row.total ?? 0}</td>
            <td>${row.ok ?? 0}</td>
            <td>${row.bad ?? 0}</td>
          `;
          campusRows.appendChild(tr);
        }

        // handbook table
        const hbRows = document.getElementById("hbRows");
        hbRows.innerHTML = "";
        const hbEntries = Object.entries(data.byHandbook || {}).sort((a,b)=> (b[1].total||0)-(a[1].total||0)).slice(0, 15);
        if (hbEntries.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="4" class="k">No handbook-context logs yet.</td>`;
          hbRows.appendChild(tr);
        } else {
          for (const [hbKey, row] of hbEntries) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(hbKey)}</td>
              <td>${row.total ?? 0}</td>
              <td>${row.ok ?? 0}</td>
              <td>${row.bad ?? 0}</td>
            `;
            hbRows.appendChild(tr);
          }
        }

      } catch (e) {
        alert("Dashboard error: " + e.message);
      }
    })();
  </script>
</body>
</html>
